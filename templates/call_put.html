{% extends "base_flask.html" %}

{% block title %}Call & Put – Options{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Navigation</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="{{ url_for('index') }}" class="nav-link">
                        <i data-lucide="home"></i>
                        <span>Home</span>
                    </a>
                </li>
                                    <li class="nav-item">
                        <a href="{{ url_for('cv_mathis_le_gall') }}" class="nav-link">
                            <i data-lucide="user"></i>
                            <span>Mathis Le Gall CV</span>
                        </a>
                    </li>
                <li class="nav-item">
                    <a href="{{ url_for('indices_actions') }}" class="nav-link">
                        <i data-lucide="candlestick-chart"></i>
                        <span>Indices & Stocks</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('analyse_actions_indices') }}" class="nav-link">
                        <i data-lucide="activity"></i>
                        <span>Stocks & Indices Analysis</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('call_put') }}" class="nav-link active">
                        <i data-lucide="line-chart"></i>
                        <span>Call & Put</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="{{ url_for('volatility_surface') }}" class="nav-link">
                        <i data-lucide="thermometer"></i>
                        <span>Implied Volatility</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('analyse_greeks') }}" class="nav-link">
                        <i data-lucide="calculator"></i>
                        <span>Greeks Analysis</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('description_app') }}" class="nav-link">
                        <i data-lucide="info"></i>
                        <span>App Description</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="content-header">
            <div class="main-header-flex">
                <div class="main-header-left">
                </div>
                <div class="main-header-center">
                    <!-- Space to balance the layout -->
                </div>
                <div class="main-header-right">
                    <h1 class="header-title">Call & Put Options</h1>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="content-area">
            <div class="main-content-area">
                <!-- Page Header -->
                <header class="page-header">
                    <div class="header-content">
                        <div class="header-left">
                            <h1 class="page-title">
                                Call & Put Options
                            </h1>
                            <p class="page-subtitle">
                                Calculation and visualization of European options with Black-Scholes and Monte Carlo models
                            </p>
                        </div>
                    </div>
                </header>

                <!-- Main Content Area -->
                <main class="options-main-content">
                    <!-- Formulaire de saisie -->
                    <div class="options-form-container">
                        <div class="form-header">
                            <h3 class="form-title">
                                <i data-lucide="settings" class="form-icon"></i>
                                Market Parameters
                            </h3>
                            <p class="form-subtitle">Configure market parameters for option calculation</p>
                        </div>
                        
                        <form id="options-form" class="options-form">
                            <!-- Paramètres principaux -->
                            <div class="form-section">
                                <h4 class="section-title">Basic Parameters</h4>
                                <div class="call-put-form-grid">
                                                                         <div class="call-put-form-field">
                                         <label for="spot-price" class="call-put-field-label">
                                             Spot Price (S)
                                         </label>
                                        <input 
                                            type="number" 
                                            id="spot-price" 
                                            name="spot-price" 
                                            value="100" 
                                            step="0.01" 
                                            min="0"
                                            placeholder="100.00"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Current price of the underlying asset</span>
                                    </div>

                                                                         <div class="call-put-form-field">
                                         <label for="strike-price" class="call-put-field-label">
                                             Strike Price (K)
                                         </label>
                                        <input 
                                            type="number" 
                                            id="strike-price" 
                                            name="strike-price" 
                                            value="100" 
                                            step="0.01" 
                                            min="0"
                                            placeholder="100.00"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Option exercise price</span>
                                    </div>

                                                                         <div class="call-put-form-field">
                                         <label for="time-maturity" class="call-put-field-label">
                                             Maturity (T) in years
                                         </label>
                                        <input 
                                            type="number" 
                                            id="time-maturity" 
                                            name="time-maturity" 
                                            value="1" 
                                            step="0.01" 
                                            min="0"
                                            placeholder="1.00"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Time until maturity</span>
                                    </div>

                                                                         <div class="call-put-form-field">
                                         <label for="risk-free-rate" class="call-put-field-label">
                                             Risk-Free Rate (r)
                                         </label>
                                        <input 
                                            type="number" 
                                            id="risk-free-rate" 
                                            name="risk-free-rate" 
                                            value="0.05" 
                                            step="0.001" 
                                            min="0" 
                                            max="1"
                                            placeholder="0.05"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Decimal (e.g., 0.05 = 5%)</span>
                                    </div>

                                                                         <div class="call-put-form-field">
                                         <label for="volatility" class="call-put-field-label">
                                             Volatility (σ)
                                         </label>
                                        <input 
                                            type="number" 
                                            id="volatility" 
                                            name="volatility" 
                                            value="0.2" 
                                            step="0.01" 
                                            min="0" 
                                            max="1"
                                            placeholder="0.20"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Decimal (e.g., 0.2 = 20%)</span>
                                    </div>

                                                                         <div class="call-put-form-field">
                                         <label for="option-type" class="call-put-field-label">
                                             Option Type
                                         </label>
                                        <select 
                                            id="option-type" 
                                            name="option-type"
                                            class="call-put-form-select"
                                        >
                                            <option value="call">Call</option>
                                            <option value="put">Put</option>
                                        </select>
                                        <span class="call-put-field-hint">Type of option to calculate</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Paramètres Monte Carlo -->
                            <div class="form-section">
                                <h4 class="section-title">Monte Carlo Parameters</h4>
                                <div class="call-put-form-grid">
                                    <div class="call-put-form-field">
                                        <label for="num-simulations" class="call-put-field-label">
                                            <i data-lucide="repeat" class="field-icon"></i>
                                            Number of simulations
                                        </label>
                                        <input 
                                            type="number" 
                                            id="num-simulations" 
                                            name="num-simulations" 
                                            value="10000" 
                                            step="1000" 
                                            min="1000"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Number of simulated paths</span>
                                    </div>

                                    <div class="call-put-form-field">
                                        <label for="num-steps" class="call-put-field-label">
                                            <i data-lucide="layers" class="field-icon"></i>
                                            Number of steps
                                        </label>
                                        <input 
                                            type="number" 
                                            id="num-steps" 
                                            name="num-steps" 
                                            value="252" 
                                            step="1" 
                                            min="1"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Time steps per simulation</span>
                                    </div>

                                    <div class="call-put-form-field">
                                        <label for="num-paths" class="call-put-field-label">
                                            <i data-lucide="trending-up" class="field-icon"></i>
                                            Paths displayed
                                        </label>
                                        <input 
                                            type="number" 
                                            id="num-paths" 
                                            name="num-paths" 
                                            value="50" 
                                            step="10" 
                                            min="0"
                                            max="200"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Paths displayed (0-200)</span>
                                    </div>

                                    <div class="call-put-form-field">
                                        <label for="confidence-level" class="call-put-field-label">
                                            <i data-lucide="shield" class="field-icon"></i>
                                            Confidence level
                                        </label>
                                        <input 
                                            type="number" 
                                            id="confidence-level" 
                                            name="confidence-level" 
                                            value="0.95" 
                                            step="0.001" 
                                            min="0.5"
                                            max="0.999"
                                            class="call-put-form-input"
                                        >
                                        <span class="call-put-field-hint">Confidence interval (0.5-0.999)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Bouton de calcul -->
                            <div class="form-actions">
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div id="calc-progress" class="progress-fill"></div>
                                        <div id="calc-chips" class="progress-chips"></div>
                                    </div>
                                    <div class="progress-labels">
                                        <span id="progress-label">Ready</span>
                                        <span id="timing-label"></span>
                                    </div>
                                </div>
                                <button 
                                    type="submit" 
                                    id="calculate-btn" 
                                    class="calculate-btn"
                                >
                                    <i data-lucide="play" class="btn-icon"></i>
                                    <span class="btn-text">Calculate Price</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Résultats -->
                    <div id="results-section" class="results-section hidden">
                        <div class="results-header">
                            <h3 class="results-title">
                                <i data-lucide="bar-chart-3" class="results-icon"></i>
                                Calculation Results
                            </h3>
                            <p class="results-subtitle">Comparison of Black-Scholes and Monte Carlo models</p>
                        </div>
                        
                        <!-- Métriques principales -->
                        <div class="metrics-grid">
                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Option Price</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="option-price-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="option-price-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Delta</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="delta-value-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="delta-value-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Gamma</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="gamma-value-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="gamma-value-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Theta</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="theta-value-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="theta-value-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Vega</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="vega-value-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="vega-value-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Rho</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">Monte Carlo</span>
                                        <span class="value-number" id="rho-value-mc">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">Black-Scholes</span>
                                        <span class="value-number" id="rho-value-bs">-</span>
                                    </div>
                                </div>
                            </div>

                                                         <div class="metric-card">
                                 <div class="metric-header">
                                     <span class="metric-label">Performance</span>
                                 </div>
                                <div class="metric-values">
                                    <div class="metric-value">
                                        <span class="value-label">MC Time (ms)</span>
                                        <span class="value-number" id="time-mc-ms">-</span>
                                    </div>
                                    <div class="metric-value">
                                        <span class="value-label">BS Time (ms)</span>
                                        <span class="value-number" id="time-bs-ms">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Intervalle de confiance -->
                        <div id="confidence-interval" class="confidence-section hidden">
                            <div class="confidence-header">
                                <i data-lucide="shield-check" class="confidence-icon"></i>
                                <h4 class="confidence-title">Monte Carlo Confidence Interval (<span id="ci-level">95%</span>)</h4>
                            </div>
                            <div class="confidence-grid">
                                <div class="confidence-card">
                                    <span class="confidence-label">Lower Bound</span>
                                    <span class="confidence-value" id="ci-lower">-</span>
                                </div>
                                <div class="confidence-card primary">
                                    <span class="confidence-label">Estimated Price</span>
                                    <span class="confidence-value" id="ci-mean">-</span>
                                </div>
                                <div class="confidence-card">
                                    <span class="confidence-label">Upper Bound</span>
                                    <span class="confidence-value" id="ci-upper">-</span>
                                </div>
                            </div>
                        </div>

                                                 <!-- Graphique -->
                         <div class="call-put-chart-section">
                             <div class="call-put-chart-header">
                                 <h4 class="call-put-chart-title">
                                     <i data-lucide="trending-up" class="call-put-chart-icon"></i>
                                     Monte Carlo Path Visualization
                                 </h4>
                                 <p class="call-put-chart-subtitle">Simulation of underlying asset price paths</p>
                             </div>
                                                           <div class="call-put-chart-container">
                                  <div class="call-put-monte-carlo-chart">
                                      <canvas id="mc-paths-chart"></canvas>
                                  </div>
                                  <div class="paths-distribution-bar" id="distribution-bar">
                                      <h5 class="distribution-title">Distribution</h5>
                                      <div class="distribution-container">
                                          <div class="distribution-bars" id="distribution-bars">
                                              <!-- Les barres seront générées dynamiquement -->
                                          </div>
                                          <div class="distribution-labels">
                                              <span class="distribution-label" id="max-label">Max</span>
                                              <span class="distribution-label" id="min-label">Min</span>
                                          </div>
                                      </div>
                                  </div>
                                  <!-- Bouton pour basculer la distribution sur petit écran -->
                                  <button id="toggle-distribution" class="toggle-distribution-btn" title="Toggle distribution">
                                      <i data-lucide="bar-chart-3"></i>
                                  </button>
                              </div>
                              <div class="chart-note">
                                  <i data-lucide="info" class="note-icon"></i>
                                  <span class="note-text">The distribution on the right shows where exactly the Monte Carlo paths displayed in the main graph end.</span>
                              </div>
                         </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Éléments DOM
    const optionsForm = document.getElementById('options-form');
    const resultsSection = document.getElementById('results-section');
    const confidenceInterval = document.getElementById('confidence-interval');
    const progressBar = document.getElementById('calc-progress');
    const chipsContainer = document.getElementById('calc-chips');
    const progressLabel = document.getElementById('progress-label');
    const timingLabel = document.getElementById('timing-label');
    const ciLevelEl = document.getElementById('ci-level');
    let mcChart = null;
    let progressTimer = null;
    let chipsTimer = null;
    
    // Gestion de la soumission du formulaire
    optionsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Récupérer les valeurs du formulaire
        const formData = new FormData(this);
        const params = {
            spotPrice: parseFloat(formData.get('spot-price')),
            strikePrice: parseFloat(formData.get('strike-price')),
            timeMaturity: parseFloat(formData.get('time-maturity')),
            riskFreeRate: parseFloat(formData.get('risk-free-rate')),
            volatility: parseFloat(formData.get('volatility')),
            optionType: formData.get('option-type'),
            modelChoice: 'both',
            numSimulations: parseInt(formData.get('num-simulations')) || 10000,
            numSteps: parseInt(formData.get('num-steps')) || 252,
            confidenceLevel: parseFloat(formData.get('confidence-level')) || 0.95,
            numPaths: parseInt(formData.get('num-paths')) || 50,
        };
        
        // Validation des paramètres
        if (!validateParams(params)) {
            return;
        }
        
        // Lancer animation barre de progression
        startProgressAnimation();

        // Appeler l'API pour calculer
        calculateOption(params);
    });
    
    // Validation des paramètres
    function validateParams(params) {
        const errors = [];
        
        if (params.spotPrice <= 0) errors.push('Spot price must be positive');
        if (params.strikePrice <= 0) errors.push('Strike price must be positive');
        if (params.timeMaturity <= 0) errors.push('Maturity must be positive');
        if (params.riskFreeRate < 0 || params.riskFreeRate > 1) errors.push('Risk-free rate must be between 0 and 1');
        if (params.volatility < 0 || params.volatility > 1) errors.push('Volatility must be between 0 and 1');
        if (params.confidenceLevel < 0.5 || params.confidenceLevel > 0.999) errors.push('Confidence level must be between 0.5 and 0.999');
        if (params.numPaths < 0 || params.numPaths > 200) errors.push('Number of paths must be between 0 and 200');
        
        if (errors.length > 0) {
            showNotification('Validation errors:\n' + errors.join('\n'), 'error');
            return false;
        }
        
        return true;
    }
    
    // Appel de l'API pour calculer l'option
    async function calculateOption(params) {
        let originalText = '';
        try {
            // Afficher un indicateur de chargement
            const calculateBtn = document.getElementById('calculate-btn');
            originalText = calculateBtn.innerHTML;
            calculateBtn.innerHTML = '<i data-lucide="loader-2" class="btn-icon spinning"></i><span class="btn-text">Calculating...</span>';
            calculateBtn.disabled = true;
            lucide.createIcons();
            
            // Appel à l'API
            const response = await fetch('/api/calculate-option', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Error during calculation');
            }
            
            // Afficher les résultats
            showResults(result);
            
        } catch (error) {
            console.error('Erreur:', error);
            showNotification('Error during calculation: ' + error.message, 'error');
        } finally {
            // Restaurer le bouton
            const calculateBtn = document.getElementById('calculate-btn');
            if (originalText) calculateBtn.innerHTML = originalText;
            calculateBtn.disabled = false;
            lucide.createIcons();
            stopProgressAnimation();
        }
    }
    
    // Affichage des résultats
    function showResults(result) {
        // Mettre à jour l'affichage Monte Carlo
        if (result.monteCarlo) {
            document.getElementById('option-price-mc').textContent = result.monteCarlo.optionPrice;
            document.getElementById('delta-value-mc').textContent = result.monteCarlo.delta ?? '-';
            document.getElementById('gamma-value-mc').textContent = result.monteCarlo.gamma ?? '-';
            document.getElementById('theta-value-mc').textContent = result.monteCarlo.theta ?? '-';
            document.getElementById('vega-value-mc').textContent = result.monteCarlo.vega ?? '-';
            document.getElementById('rho-value-mc').textContent = result.monteCarlo.rho ?? '-';

            // Intervalle de confiance
            if (result.monteCarlo.confidenceInterval) {
                document.getElementById('ci-lower').textContent = result.monteCarlo.confidenceInterval.lower;
                document.getElementById('ci-mean').textContent = result.monteCarlo.confidenceInterval.mean;
                document.getElementById('ci-upper').textContent = result.monteCarlo.confidenceInterval.upper;
                const levelPct = Math.round((result.monteCarlo.confidenceInterval.confidenceLevel || 0.95) * 100);
                ciLevelEl.textContent = levelPct + '%';
                confidenceInterval.classList.remove('hidden');
            } else {
                confidenceInterval.classList.add('hidden');
            }

            // Temps MC
            if (typeof result.monteCarlo.timeMs !== 'undefined') {
                const t = Number(result.monteCarlo.timeMs);
                document.getElementById('time-mc-ms').textContent = isFinite(t) ? t.toString() : '-';
            }

            // Graphique chemins
            if (result.monteCarlo.paths && result.monteCarlo.timeGrid) {
                updateMcChart({ paths: result.monteCarlo.paths, timeGrid: result.monteCarlo.timeGrid });
            } else if (result.paths && result.timeGrid) {
                updateMcChart({ paths: result.paths, timeGrid: result.timeGrid });
            }
        }

        // Mettre à jour l'affichage Black-Scholes
        if (result.blackScholes) {
            document.getElementById('option-price-bs').textContent = result.blackScholes.optionPrice;
            document.getElementById('delta-value-bs').textContent = result.blackScholes.delta;
            document.getElementById('gamma-value-bs').textContent = result.blackScholes.gamma;
            document.getElementById('theta-value-bs').textContent = result.blackScholes.theta;
            if (typeof result.blackScholes.vega !== 'undefined') {
                document.getElementById('vega-value-bs').textContent = result.blackScholes.vega;
            }
            if (typeof result.blackScholes.rho !== 'undefined') {
                document.getElementById('rho-value-bs').textContent = result.blackScholes.rho;
            }
            
            // Temps BS
            if (typeof result.blackScholes.timeMs !== 'undefined') {
                const t = Number(result.blackScholes.timeMs);
                document.getElementById('time-bs-ms').textContent = isFinite(t) ? t.toString() : '-';
            }
        }
        
        // Compatibilité ancienne structure
        if (!result.monteCarlo && result.model === 'monte-carlo' && result.confidenceInterval) {
            document.getElementById('ci-lower').textContent = result.confidenceInterval.lower;
            document.getElementById('ci-mean').textContent = result.confidenceInterval.mean;
            document.getElementById('ci-upper').textContent = result.confidenceInterval.upper;
            confidenceInterval.classList.remove('hidden');
        }
        
        // Afficher la section des résultats
        resultsSection.classList.remove('hidden');
        
        // Scroll vers les résultats avec animation
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Animation d'apparition des résultats
        animateResults();
    }

    // Animation des résultats
    function animateResults() {
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('animate-in');
            }, index * 100);
        });
    }

    // Animation barre de progression
    function startProgressAnimation() {
        if (progressTimer) clearInterval(progressTimer);
        if (chipsTimer) clearInterval(chipsTimer);
        
        // Reset
        progressBar.style.width = '0%';
        progressLabel.textContent = 'Calcul…';
        timingLabel.textContent = '';
        
        // Génère 12 chips si pas déjà
        if (chipsContainer && chipsContainer.children.length === 0) {
            for (let i = 0; i < 12; i++) {
                const chip = document.createElement('div');
                chip.className = 'progress-chip';
                chipsContainer.appendChild(chip);
            }
        }
        chipsContainer.style.opacity = '1';

        // Progression douce 0->90% puis attend la fin pour 100%
        let p = 0;
        progressTimer = setInterval(() => {
            p += Math.max(0.1, 0.5 * Math.random()); // Progression plus lente
            if (p > 90) p = 90;
            progressBar.style.width = p + '%';
        }, 200); // Intervalle plus long

        // Animation chips: allumage séquentiel
        let idx = 0;
        chipsTimer = setInterval(() => {
            const n = chipsContainer.children.length;
            for (let i = 0; i < n; i++) {
                const el = chipsContainer.children[i];
                const active = (i <= idx % n);
                el.style.opacity = active ? '1' : '0.25';
            }
            idx++;
        }, 150); // Animation chips plus lente
    }

    function stopProgressAnimation() {
        if (progressTimer) clearInterval(progressTimer);
        if (chipsTimer) clearInterval(chipsTimer);
        progressTimer = null;
        chipsTimer = null;
        progressBar.style.width = '100%';
        progressLabel.textContent = 'Terminé';
        setTimeout(() => { chipsContainer.style.opacity = '0'; }, 300);
    }

    // Visualisation des chemins de Monte Carlo
    function updateMcChart(result) {
        try {
            const ctx = document.getElementById('mc-paths-chart').getContext('2d');
            if (!result.paths || !result.timeGrid) {
                if (mcChart) {
                    mcChart.destroy();
                    mcChart = null;
                }
                return;
            }

            const datasets = result.paths.map((path, idx) => ({
                label: `Path ${idx + 1}`,
                data: result.timeGrid.map((t, i) => ({ x: t, y: path[i] })),
                borderColor: `hsla(${(idx * 47) % 360}, 70%, 60%, 0.6)`,
                backgroundColor: `hsla(${(idx * 47) % 360}, 70%, 60%, 0.1)`,
                borderWidth: 1.5,
                fill: false,
                pointRadius: 0,
                tension: 0.1,
            }));

            if (mcChart) mcChart.destroy();

            // Détecter la taille de l'écran pour adapter les options
            const isSmallScreen = window.innerWidth <= 768;
            const isVerySmallScreen = window.innerWidth <= 480;
            
            mcChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: isSmallScreen ? 500 : 1000, // Animation plus rapide sur petit écran
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { 
                                display: !isVerySmallScreen, // Masquer le titre sur très petit écran
                                text: 'Time (years)',
                                color: '#e5e7eb',
                                font: { 
                                    size: isSmallScreen ? 12 : 14, 
                                    weight: '600' 
                                }
                            },
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#9ca3af',
                                font: { size: isSmallScreen ? 10 : 12 },
                                maxTicksLimit: isSmallScreen ? 5 : 10 // Moins de ticks sur petit écran
                            },
                            border: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: {
                            title: { 
                                display: !isVerySmallScreen, // Masquer le titre sur très petit écran
                                text: 'Underlying Asset Price',
                                color: '#e5e7eb',
                                font: { 
                                    size: isSmallScreen ? 12 : 14, 
                                    weight: '600' 
                                }
                            },
                            grid: { 
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#9ca3af',
                                font: { size: isSmallScreen ? 10 : 12 },
                                maxTicksLimit: isSmallScreen ? 4 : 8 // Moins de ticks sur petit écran
                            },
                            border: { color: 'rgba(255,255,255,0.2)' }
                        },
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#f9fafb',
                            bodyColor: '#e5e7eb',
                            borderColor: '#374151',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            titleFont: { size: isSmallScreen ? 12 : 14 },
                            bodyFont: { size: isSmallScreen ? 11 : 13 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                },
            });

            // Mettre à jour la distribution des chemins (utilise exactement les mêmes chemins que le graphique)
            updatePathsDistribution(result.paths);
        } catch (e) {
            console.error('Erreur chart MC:', e);
        }
    }

    // Mise à jour de la distribution des chemins
    function updatePathsDistribution(paths) {
        try {
            const distributionBars = document.getElementById('distribution-bars');
            const maxLabel = document.getElementById('max-label');
            const minLabel = document.getElementById('min-label');
            
            if (!distributionBars || !paths || paths.length === 0) return;

            // Récupérer les valeurs finales des chemins affichés (pas tous les chemins simulés)
            const finalValues = paths.map(path => path[path.length - 1]);
            
            // Calculer les statistiques
            const min = Math.min(...finalValues);
            const max = Math.max(...finalValues);
            const range = max - min;
            
            // Mettre à jour les labels
            maxLabel.textContent = max.toFixed(1);
            minLabel.textContent = min.toFixed(1);
            
            // Créer des bins pour la distribution (20 bins)
            const numBins = 20;
            const binSize = range / numBins;
            const bins = new Array(numBins).fill(0);
            
            // Compter les chemins dans chaque bin
            finalValues.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binSize), numBins - 1);
                bins[binIndex]++;
            });
            
            // Trouver le maximum pour normaliser
            const maxCount = Math.max(...bins);
            
            // Générer les barres de distribution
            distributionBars.innerHTML = '';
            bins.forEach((count, index) => {
                const bar = document.createElement('div');
                bar.className = 'distribution-bar';
                
                // Toutes les barres ont la même hauteur (intervalles de même taille)
                bar.style.height = '100%';
                
                // Couleur verte fixe pour toutes les barres
                const greenColor = '#10b981'; // Vert fixe
                
                // Intensité basée sur le nombre de chemins
                const intensity = count > 0 ? Math.max(0.3, count / maxCount) : 0.1;
                
                // Appliquer la couleur verte avec l'intensité
                const color = count > 0 ? greenColor : 'rgba(156, 163, 175, 0.3)'; // Gris pâle pour les bins vides
                
                bar.style.background = color;
                bar.style.opacity = intensity;
                
                // Tooltip avec informations
                const binStart = min + index * binSize;
                const binEnd = min + (index + 1) * binSize;
                bar.title = `Price: ${binStart.toFixed(1)} - ${binEnd.toFixed(1)}\nPaths: ${count} (${((count/paths.length)*100).toFixed(1)}%)`;
                
                distributionBars.appendChild(bar);
            });
            
        } catch (e) {
            console.error('Erreur distribution:', e);
        }
    }

    // Notification système
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i data-lucide="${type === 'error' ? 'alert-circle' : 'info'}" class="notification-icon"></i>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i data-lucide="x"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        lucide.createIcons();
        
        // Auto-remove après 5 secondes
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Validation en temps réel
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('error');
        });
        
        input.addEventListener('blur', function() {
            const value = parseFloat(this.value);
            const min = parseFloat(this.min);
            const max = parseFloat(this.max);
            
            if (this.value && (isNaN(value) || (min !== undefined && value < min) || (max !== undefined && value > max))) {
                this.classList.add('error');
            }
        });
    });

    // Gestion du menu mobile
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function() {
            sidebar.classList.toggle('mobile-open');
        });
    }

    // Fermer le menu mobile en cliquant à l'extérieur
    document.addEventListener('click', function(e) {
        if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
            sidebar.classList.remove('mobile-open');
        }
    });

    // Gestion du redimensionnement de la fenêtre pour le graphique
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (mcChart) {
                mcChart.resize();
                mcChart.render();
            }
        }, 250); // Délai pour éviter trop de recalculs
    });

    // Gestion du bouton de basculement de la distribution
    const toggleDistributionBtn = document.getElementById('toggle-distribution');
    const distributionBar = document.getElementById('distribution-bar');
    
    if (toggleDistributionBtn && distributionBar) {
        toggleDistributionBtn.addEventListener('click', function() {
            distributionBar.classList.toggle('hidden');
            
            // Redimensionner le graphique après l'animation
            setTimeout(() => {
                if (mcChart) {
                    mcChart.resize();
                    mcChart.render();
                }
            }, 300);
            
            // Mettre à jour l'icône du bouton
            const icon = this.querySelector('i');
            if (distributionBar.classList.contains('hidden')) {
                icon.setAttribute('data-lucide', 'eye');
            } else {
                icon.setAttribute('data-lucide', 'bar-chart-3');
            }
            lucide.createIcons();
        });
    }
</script>
{% endblock %}

